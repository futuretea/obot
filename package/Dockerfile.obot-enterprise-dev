ARG TOOLS_IMAGE=ghcr.io/futuretea/obot-tools:latest
ARG BASE_IMAGE=ghcr.io/futuretea/obot-enterprise:master

# Stage 1: Build keycloak-auth-provider from local source
FROM golang:1.25-alpine AS keycloak-builder
WORKDIR /build

# Install build dependencies
RUN apk add --no-cache git

# Copy keycloak-auth-provider and auth-providers-common source
COPY keycloak-auth-provider/ ./keycloak-auth-provider/
COPY auth-providers-common/ ./auth-providers-common/

# Build keycloak-auth-provider
WORKDIR /build/keycloak-auth-provider
RUN go build -ldflags="-s -w" -o bin/gptscript-go-tool .

# Stage 2: Get pre-built tools
FROM ${TOOLS_IMAGE} AS tools

# Stage 3: Final image
FROM ${BASE_IMAGE}

# Switch to root to install CA certificate
USER root

# Copy your enterprise CA certificate
COPY enterprise-ca.crt /usr/local/share/ca-certificates/enterprise-ca.crt

# Merge enterprise CA with system CA bundle
# Wolfi doesn't have update-ca-certificates, so we concatenate manually
RUN cat /usr/local/share/ca-certificates/enterprise-ca.crt >> /etc/ssl/certs/ca-certificates.crt

# Switch back to original user if needed
# USER obot

# Remove existing keycloak-auth-provider and copy from pre-built tools
RUN rm -rf /obot-tools/tools/keycloak-auth-provider
COPY --link --from=tools /obot-tools/tools/keycloak-auth-provider /obot-tools/tools/keycloak-auth-provider

# Override with locally built keycloak-auth-provider binary
COPY --from=keycloak-builder /build/keycloak-auth-provider/bin/gptscript-go-tool /obot-tools/tools/keycloak-auth-provider/bin/gptscript-go-tool
