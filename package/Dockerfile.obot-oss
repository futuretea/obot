ARG TOOLS_IMAGE=ghcr.io/futuretea/obot-tools:latest
ARG BASE_IMAGE=ghcr.io/futuretea/obot:master

# Stage 1: Get pre-built tools
FROM ${TOOLS_IMAGE} AS tools

# Stage 2: Final image
FROM ${BASE_IMAGE}

# Switch to root to install CA certificate
USER root

# Copy your enterprise CA certificate
COPY enterprise-ca.crt /usr/local/share/ca-certificates/enterprise-ca.crt

# Merge enterprise CA with system CA bundle
# Wolfi doesn't have update-ca-certificates, so we concatenate manually
RUN cat /usr/local/share/ca-certificates/enterprise-ca.crt >> /etc/ssl/certs/ca-certificates.crt

# Disable default MCP catalog GitHub access
ENV OBOT_SERVER_DEFAULT_MCPCATALOG_PATH=""

# Switch back to original user if needed
# USER obot

# Remove existing keycloak-auth-provider and copy from pre-built tools
RUN rm -rf /obot-tools/tools/keycloak-auth-provider
COPY --link --from=tools /obot-tools/tools/keycloak-auth-provider /obot-tools/tools/keycloak-auth-provider

# Remove existing qwen-model-provider and copy from pre-built tools
RUN rm -rf /obot-tools/tools/qwen-model-provider
COPY --link --from=tools /obot-tools/tools/qwen-model-provider /obot-tools/tools/qwen-model-provider
